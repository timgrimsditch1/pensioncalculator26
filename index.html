<!DOCTYPE html><script src="/__replco/static/devtools/eruda/3.2.3/eruda.js"></script><script src="/__replco/static/devtools/injected.js"onerror="parent.postMessage({event:'error',payload:'script.onerror: Failed to load '+event.target.src},'https://replit.com')"></script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .section-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .summary-section {
            background-color: #f8fafc;
            border-left: 4px solid #f97316;
        }

        .chart-section {
            background-color: #fafafa;
            border-left: 4px solid #f97316;
        }

        .table-section {
            background-color: #f9fafb;
            border-left: 4px solid #f97316;
        }

        .section-title {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-4">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="mb-4">
                <h1 class="text-2xl font-bold mb-2">Pension Calculator</h1>
            </div>

            <!-- Account (Login + Save/Load) -->
            <div id="accountPanel" class="mb-6 p-4 rounded-lg border bg-gray-50">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
                    <div class="flex-1">
                        <div class="font-semibold mb-1">Save & retrieve your results</div>
                        <div class="text-sm text-gray-600 mb-2">
                            Log in with an email magic link, then save scenarios and reload them later.
                        </div>

                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="authEmail" type="email" placeholder="you@example.com"
                                class="w-full sm:max-w-sm px-3 py-2 rounded border bg-white" />
                            <button id="authSendLinkBtn" type="button"
                                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                                Send login link
                            </button>
                            <button id="authLogoutBtn" type="button"
                                class="px-4 py-2 rounded bg-gray-700 text-white hover:bg-gray-800 hidden">
                                Log out
                            </button>
                        </div>

                        <div id="authStatus" class="text-sm text-gray-700 mt-2"></div>
                        <div id="supabaseConfigWarning" class="text-sm text-amber-700 mt-2 hidden">
                            Supabase is not configured yet. Open this HTML file and set <code class="px-1 bg-amber-100 rounded">SUPABASE_URL</code> and
                            <code class="px-1 bg-amber-100 rounded">SUPABASE_ANON_KEY</code>.
                        </div>
                    </div>

                    <div class="flex-1">
                        <div class="font-semibold mb-2">Saved scenarios</div>

                        <div class="flex flex-col sm:flex-row gap-2 mb-2">
                            <input id="runLabel" type="text" placeholder="Label (e.g., Base case)"
                                class="w-full px-3 py-2 rounded border bg-white" />
                            <button id="saveRunBtn" type="button"
                                class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                                Save current results
                            </button>
                        </div>

                        <div id="runsList" class="text-sm text-gray-700">
                            <div class="text-gray-500">Log in to see saved scenarios.</div>
                        </div>
                    </div>
                </div>
            </div>


            <form id="calculatorForm" class="space-y-8 mb-6">
                <!-- About You Section -->
                <div class="border-2 rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-black">About You</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Current Age</label>
                            <input type="number" name="currentAge" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Retirement Age</label>
                            <input type="number" name="retirementAge" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                </div>

                <!-- Your Finances Section -->
                <div class="border-2 rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-black">Your Finances</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Current Pension Savings (£)</label>
                            <input type="number" name="currentPensionSavings" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Annual Pension Contributions (£)</label>
                            <input type="number" name="annualPensionContributions" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Current ISA Savings (£)</label>
                            <input type="number" name="currentIsaSavings" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Annual ISA Contributions (£)</label>
                            <input type="number" name="annualIsaContributions" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Other Income Annual (£)</label>
                            <input type="number" name="postRetirementIncome" value="0" class="w-full px-3 py-2 border rounded-md">
                            <p class="text-sm text-gray-500 mt-1">e.g. rental property income</p>
                        </div>
                    </div>
                </div>

                <!-- Your Goal Section -->
                <div class="border-2 rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-black">Your Goal</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Desired Post-Tax Income (£)</label>
                            <input type="number" name="desiredPostTaxIncome" value="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" name="takeLumpSum" checked class="rounded text-orange-500">
                            <label>Take 25% tax-free lump sum at age 55</label>
                        </div>
                    </div>
                </div>

                <!-- Market Rates Section -->
                <div class="border-2 rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-black">Market Rates</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Investment Return Rate (%)</label>
                            <input type="number" name="returnRate" value="7" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block mb-2">Inflation Rate (%)</label>
                            <input type="number" name="inflationRate" value="2" class="w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600">
                    Calculate
                </button>
            </form>

            <div id="results" class="hidden">
                <div id="summary" class="section-card summary-section">
                    <h3 class="section-title">Summary</h3>
                    <!-- Summary content will be inserted here by JavaScript -->
                </div>

                <div class="section-card chart-section">
                    <h3 class="section-title">Total Savings Over Time</h3>
                    <p class="text-sm text-gray-500 mb-4">All values are adjusted for inflation over time</p>
                    <canvas id="savingsChart" class="w-full h-64 mb-6"></canvas>
                </div>

                <div class="section-card chart-section">
                    <h3 class="section-title">Income Sources in Retirement</h3>
                    <p class="text-sm text-gray-500 mb-4">All values are adjusted for inflation over time</p>
                    <canvas id="incomeChart" class="w-full h-64 mb-6"></canvas>
                </div>

                <div class="section-card table-section">
                    <h3 class="section-title">Year By Year Results</h3>
                    <p class="text-sm text-gray-500 mb-4">All values are adjusted for inflation over time</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left">Age</th>
                                    <th class="px-4 py-2 text-left">Combined Pension and ISA Savings</th>
                                    <th class="px-4 py-2 text-left">Investment Returns</th>
                                    <th class="px-4 py-2 text-left">Combined Pension and ISA Contributions</th>
                                    <th class="px-4 py-2 text-left">Pension Income (Post-Tax)</th>
                                    <th class="px-4 py-2 text-left">ISA Income</th>
                                    <th class="px-4 py-2 text-left">Post-Retirement Income</th>
                                    <th class="px-4 py-2 text-left">State Pension</th>
                                    <th class="px-4 py-2 text-left">Total Income</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let savingsChart = null;
        let incomeChart = null;

        // ----------------------------
        // Supabase (Phase 2: GitHub + Supabase)
        // ----------------------------
        // 1) Create a Supabase project, then paste your Project URL + Anon Public Key below.
        // 2) In Supabase Auth settings, set Site URL + Redirect URL to your GitHub Pages URL.
        const SUPABASE_URL = "https://txhgjdruoyzvslnoyqjv.supabase.co";      // e.g. "https://txhgjdruoyzvslnoyqjv.supabase.co"
        const SUPABASE_ANON_KEY = "sb_publishable_5h-OFkrBpXxS0FNMZ6tjjw_YdB19ocS"; // e.g. "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        const TARGET_DEPLETION_AGE = 90;

        let supabaseClient = null;

        // Latest computed state (for "Save current results")
        let latestInputs = null;
        let latestResults = null;

        function isSupabaseConfigured() {
            return Boolean(SUPABASE_URL && SUPABASE_ANON_KEY);
        }

        function ensureSupabaseClient() {
            if (!isSupabaseConfigured()) return null;
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }

        function formatDateTime(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleString();
            } catch {
                return iso;
            }
        }

        async function getCurrentUser() {
            const client = ensureSupabaseClient();
            if (!client) return null;
            const { data: { user } } = await client.auth.getUser();
            return user || null;
        }

        function setAuthStatus(msg, toneClass = "text-gray-700") {
            const el = document.getElementById("authStatus");
            if (!el) return;
            el.className = "text-sm mt-2 " + toneClass;
            el.textContent = msg || "";
        }

        async function updateAuthUI() {
            const configured = isSupabaseConfigured();
            const warning = document.getElementById("supabaseConfigWarning");
            if (warning) warning.classList.toggle("hidden", configured);

            const logoutBtn = document.getElementById("authLogoutBtn");
            const saveBtn = document.getElementById("saveRunBtn");
            const runsList = document.getElementById("runsList");

            if (!configured) {
                if (logoutBtn) logoutBtn.classList.add("hidden");
                if (saveBtn) saveBtn.disabled = true;
                if (runsList) runsList.innerHTML = '<div class="text-gray-500">Configure Supabase to enable saving.</div>';
                setAuthStatus("");
                return;
            }

            const user = await getCurrentUser();
            if (!user) {
                if (logoutBtn) logoutBtn.classList.add("hidden");
                if (saveBtn) saveBtn.disabled = true;
                if (runsList) runsList.innerHTML = '<div class="text-gray-500">Log in to see saved scenarios.</div>';
                setAuthStatus("Not logged in.");
                return;
            }

            if (logoutBtn) logoutBtn.classList.remove("hidden");
            if (saveBtn) saveBtn.disabled = !(latestInputs && latestResults);
            setAuthStatus(`Logged in as ${user.email || "user"}.`, "text-green-700");
            await loadRuns();
        }

        async function sendMagicLink(email) {
            const client = ensureSupabaseClient();
            if (!client) return;

            const redirectTo = window.location.href;
            const { error } = await client.auth.signInWithOtp({
                email,
                options: { emailRedirectTo: redirectTo }
            });
            if (error) throw error;
        }

        async function logout() {
            const client = ensureSupabaseClient();
            if (!client) return;
            await client.auth.signOut();
        }

        async function saveCurrentRun() {
            const client = ensureSupabaseClient();
            if (!client) return;

            const user = await getCurrentUser();
            if (!user) {
                setAuthStatus("Please log in first.", "text-red-700");
                return;
            }
            if (!latestInputs || !latestResults) {
                setAuthStatus("Calculate results first, then save.", "text-red-700");
                return;
            }

            const label = (document.getElementById("runLabel")?.value || "").trim() || "Saved run";

            // Store both inputs + results (results stored for convenience, but we recompute on load)
            const payload = {
                user_id: user.id,
                label,
                inputs: latestInputs,
                results: latestResults
            };

            const { error } = await client.from("pension_runs").insert([payload]);
            if (error) throw error;

            setAuthStatus("Saved.", "text-green-700");
            await loadRuns();
        }

        async function loadRuns() {
            const runsList = document.getElementById("runsList");
            const client = ensureSupabaseClient();
            if (!client || !runsList) return;

            const user = await getCurrentUser();
            if (!user) return;

            const { data, error } = await client
                .from("pension_runs")
                .select("id, created_at, label, inputs")
                .order("created_at", { ascending: false })
                .limit(10);

            if (error) {
                runsList.innerHTML = '<div class="text-red-700">Could not load saved scenarios.</div>';
                return;
            }

            if (!data || data.length === 0) {
                runsList.innerHTML = '<div class="text-gray-500">No saved scenarios yet.</div>';
                return;
            }

            const rows = data.map(run => {
                const safeLabel = (run.label || "Saved run").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `
                    <div class="flex items-center justify-between gap-3 py-2 border-t">
                        <div class="min-w-0">
                            <div class="font-semibold truncate">${safeLabel}</div>
                            <div class="text-xs text-gray-500">${formatDateTime(run.created_at)}</div>
                        </div>
                        <div class="shrink-0 flex gap-2">
                            <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700"
                                data-load-run-id="${run.id}">
                                Load
                            </button>
                        </div>
                    </div>
                `;
            }).join("");

            runsList.innerHTML = `<div class="border rounded bg-white">${rows}</div>`;

            // Wire up load buttons
            runsList.querySelectorAll("[data-load-run-id]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.getAttribute("data-load-run-id");
                    await loadRunById(id);
                });
            });
        }

        async function loadRunById(id) {
            const client = ensureSupabaseClient();
            if (!client) return;

            const { data, error } = await client
                .from("pension_runs")
                .select("inputs")
                .eq("id", id)
                .single();

            if (error || !data?.inputs) {
                setAuthStatus("Could not load that scenario.", "text-red-700");
                return;
            }

            const inputs = data.inputs;

            // Populate form
            const form = document.getElementById("calculatorForm");
            if (!form) return;

            const setVal = (name, value) => {
                const el = form.querySelector(`[name="${name}"]`);
                if (!el) return;
                if (el.type === "checkbox") {
                    el.checked = Boolean(value);
                } else {
                    el.value = value;
                }
            };

            setVal("currentAge", inputs.currentAge);
            setVal("retirementAge", inputs.retirementAge);
            setVal("currentPensionSavings", inputs.currentPensionSavings);
            setVal("annualPensionContributions", inputs.annualPensionContributions);
            setVal("currentIsaSavings", inputs.currentIsaSavings);
            setVal("annualIsaContributions", inputs.annualIsaContributions);
            setVal("desiredPostTaxIncome", inputs.desiredPostTaxIncome);
            setVal("postRetirementIncome", inputs.postRetirementIncome);
            setVal("returnRate", inputs.returnRate);
            setVal("inflationRate", inputs.inflationRate);
            setVal("takeLumpSum", inputs.takeLumpSum);

            // Recalculate & render
            const results = calculatePension(inputs);
            updateResults(results, inputs);
            setAuthStatus("Loaded scenario.", "text-green-700");
        }

        function calculateTax(income, yearsSinceStart, inflationRate) {
            const inflationFactor = Math.pow(1 + inflationRate / 100, yearsSinceStart);
            const personalAllowance = 12570 * inflationFactor;
            const basicRateLimit = 50270 * inflationFactor;
            const additionalRateLimit = 125140 * inflationFactor;

            let tax = 0;
            let remaining = income;

            if (remaining > additionalRateLimit) {
                tax += (remaining - additionalRateLimit) * 0.45;
                remaining = additionalRateLimit;
            }
            if (remaining > basicRateLimit) {
                tax += (remaining - basicRateLimit) * 0.4;
                remaining = basicRateLimit;
            }
            if (remaining > personalAllowance) {
                tax += (remaining - personalAllowance) * 0.2;
            }

            return tax;
        }

        function calculateOptimalWithdrawals(targetIncome, pensionPot, isaPot, statePension, yearsSinceStart, inflationRate) {
            const inflationFactor = Math.pow(1 + inflationRate / 100, yearsSinceStart);
            const personalAllowance = 12570 * inflationFactor;
            const basicRateLimit = 50270 * inflationFactor;

            let remainingNeeded = targetIncome;
            let pensionWithdrawal = 0;
            let isaWithdrawal = 0;

            // First use state pension
            remainingNeeded -= statePension;

            // Then use ISA first (tax-free)
            if (remainingNeeded > 0) {
                const isaAmount = Math.min(remainingNeeded, isaPot);
                isaWithdrawal = isaAmount;
                remainingNeeded -= isaAmount;
            }

            // Then use pension if needed
            if (remainingNeeded > 0) {
                const grossPensionNeeded = remainingNeeded + calculateTax(remainingNeeded + statePension, yearsSinceStart, inflationRate);
                pensionWithdrawal = Math.min(grossPensionNeeded, pensionPot);
                remainingNeeded -= (pensionWithdrawal - calculateTax(pensionWithdrawal + statePension, yearsSinceStart, inflationRate));
            }

            // Use remaining pension if needed
            if (remainingNeeded > 0) {
                const additionalPensionNet = remainingNeeded;
                const additionalPensionGross = additionalPensionNet + 
                    calculateTax(additionalPensionNet + statePension + isaWithdrawal + pensionWithdrawal, yearsSinceStart, inflationRate);
                pensionWithdrawal += Math.min(additionalPensionGross, Math.max(0, pensionPot - pensionWithdrawal));
            }

            return { pensionWithdrawal, isaWithdrawal };
        }

        function getLifeExpectancy(currentAge) {
            const lifeExpectancyData = [
                // CSV data converted to array
                {age: 0, females: 83.04}, {age: 1, females: 82.33}, {age: 2, females: 81.35},
                {age: 3, females: 80.36}, {age: 4, females: 79.37}, {age: 5, females: 78.38},
                {age: 6, females: 77.38}, {age: 7, females: 76.39}, {age: 8, females: 75.39},
                {age: 9, females: 74.40}, {age: 10, females: 73.40}, {age: 11, females: 72.41},
                {age: 12, females: 71.41}, {age: 13, females: 70.42}, {age: 14, females: 69.42},
                {age: 15, females: 68.43}, {age: 16, females: 67.44}, {age: 17, females: 66.45},
                {age: 18, females: 65.46}, {age: 19, females: 64.47}, {age: 20, females: 63.48},
                {age: 21, females: 62.49}, {age: 22, females: 61.51}, {age: 23, females: 60.52},
                {age: 24, females: 59.53}, {age: 25, females: 58.55}, {age: 26, females: 57.56},
                {age: 27, females: 56.58}, {age: 28, females: 55.59}, {age: 29, females: 54.61},
                {age: 30, females: 53.63}, {age: 31, females: 52.65}, {age: 32, females: 51.67},
                {age: 33, females: 50.69}, {age: 34, females: 49.71}, {age: 35, females: 48.74},
                {age: 36, females: 47.77}, {age: 37, females: 46.80}, {age: 38, females: 45.83},
                {age: 39, females: 44.87}, {age: 40, females: 43.91}, {age: 41, females: 42.95},
                {age: 42, females: 41.99}, {age: 43, females: 41.04}, {age: 44, females: 40.09},
                {age: 45, females: 39.14}, {age: 46, females: 38.19}, {age: 47, females: 37.25},
                {age: 48, females: 36.32}, {age: 49, females: 35.39}, {age: 50, females: 34.46},
                {age: 51, females: 33.54}, {age: 52, females: 32.62}, {age: 53, females: 31.70},
                {age: 54, females: 30.79}, {age: 55, females: 29.88}, {age: 56, females: 28.98},
                {age: 57, females: 28.08}, {age: 58, females: 27.20}, {age: 59, females: 26.31},
                {age: 60, females: 25.43}, {age: 61, females: 24.56}, {age: 62, females: 23.69},
                {age: 63, females: 22.83}, {age: 64, females: 21.98}, {age: 65, females: 21.14},
                {age: 66, females: 20.31}, {age: 67, females: 19.49}, {age: 68, females: 18.67},
                {age: 69, females: 17.87}, {age: 70, females: 17.07}, {age: 71, females: 16.29},
                {age: 72, females: 15.51}, {age: 73, females: 14.74}, {age: 74, females: 13.99},
                {age: 75, females: 13.24}, {age: 76, females: 12.51}, {age: 77, females: 11.80},
                {age: 78, females: 11.11}, {age: 79, females: 10.43}, {age: 80, females: 9.78},
                {age: 81, females: 9.15}, {age: 82, females: 8.55}, {age: 83, females: 7.97},
                {age: 84, females: 7.41}, {age: 85, females: 6.87}, {age: 86, females: 6.36},
                {age: 87, females: 5.87}, {age: 88, females: 5.41}, {age: 89, females: 4.99},
                {age: 90, females: 4.59}, {age: 91, females: 4.23}, {age: 92, females: 3.89},
                {age: 93, females: 3.59}, {age: 94, females: 3.32}, {age: 95, females: 3.06},
                {age: 96, females: 2.83}, {age: 97, females: 2.60}, {age: 98, females: 2.41},
                {age: 99, females: 2.25}, {age: 100, females: 2.09}
            ];

            const entry = lifeExpectancyData.find(d => d.age === currentAge);
            if (!entry) {
                return currentAge + 2; // fallback for ages over 100
            }
            return currentAge + entry.females;
        }

        function calculatePension(inputs) {
            const endAge = Math.ceil(getLifeExpectancy(inputs.currentAge));
            let savingsTrajectory = [];
            let runOutAge = null;
            let pensionPot = inputs.currentPensionSavings;
            let isaPot = inputs.currentIsaSavings;
            let lumpSumTaken = false;

            for (let currentAge = inputs.currentAge; currentAge <= endAge; currentAge++) {
                const yearsSinceStart = currentAge - inputs.currentAge;
                const inflationFactor = Math.pow(1 + inputs.inflationRate / 100, yearsSinceStart);

                const pensionReturns = pensionPot * (inputs.returnRate / 100);
                const isaReturns = isaPot * (inputs.returnRate / 100);
                const totalReturns = pensionReturns + isaReturns;

                let pensionWithdrawal = 0;
                let isaWithdrawal = 0;
                let lumpSumThisYear = 0;
                let statePension = currentAge >= 67 ? 11502 * inflationFactor : 0;
                let postRetirementIncome = currentAge >= inputs.retirementAge ? inputs.postRetirementIncome * inflationFactor : 0;

                if (currentAge < inputs.retirementAge) {
                    const inflatedPensionContribution = inputs.annualPensionContributions * inflationFactor;
                    const inflatedIsaContribution = inputs.annualIsaContributions * inflationFactor;

                    if (!lumpSumTaken && inputs.takeLumpSum && currentAge === Math.max(55, inputs.currentAge)) {
                        lumpSumThisYear = pensionPot * 0.25;
                        pensionPot -= lumpSumThisYear;
                        lumpSumTaken = true;
                    }

                    pensionPot += inflatedPensionContribution + pensionReturns;
                    isaPot += inflatedIsaContribution + isaReturns;
                } else {
                    if (!lumpSumTaken && inputs.takeLumpSum) {
                        lumpSumThisYear = pensionPot * 0.25;
                        pensionPot -= lumpSumThisYear;
                        lumpSumTaken = true;
                    }

                    // Calculate withdrawals before adding returns
                    const targetIncome = inputs.desiredPostTaxIncome * inflationFactor - postRetirementIncome;
                    const withdrawals = calculateOptimalWithdrawals(
                        targetIncome,
                        pensionPot + pensionReturns,  // Include this year's returns in available funds
                        isaPot + isaReturns,          // Include this year's returns in available funds
                        statePension,
                        yearsSinceStart,
                        inputs.inflationRate
                    );

                    pensionWithdrawal = withdrawals.pensionWithdrawal;
                    isaWithdrawal = withdrawals.isaWithdrawal;

                    // Add returns and subtract withdrawals
                    pensionPot = (pensionPot + pensionReturns) - pensionWithdrawal;
                    isaPot = (isaPot + isaReturns) - isaWithdrawal;
                }

                const taxPaid = currentAge >= inputs.retirementAge ?
                    calculateTax(pensionWithdrawal + statePension, yearsSinceStart, inputs.inflationRate) : 0;

                savingsTrajectory.push({
                    age: currentAge,
                    totalSavings: Math.round(pensionPot + isaPot),
                    pensionSavings: Math.round(pensionPot),
                    isaSavings: Math.round(isaPot),
                    returns: Math.round(totalReturns),
                    contributions: currentAge < inputs.retirementAge ?
                        Math.round(inputs.annualPensionContributions * inflationFactor +
                                inputs.annualIsaContributions * inflationFactor) : 0,
                    pensionWithdrawalPostTax: Math.round(Math.max(0, pensionWithdrawal - taxPaid)),
                    isaWithdrawal: Math.round(isaWithdrawal),
                    lumpSum: Math.round(lumpSumThisYear),
                    statePension: Math.round(statePension),
                    postRetirementIncome: Math.round(postRetirementIncome),
                    totalIncome: Math.round(pensionWithdrawal - taxPaid + isaWithdrawal + statePension + postRetirementIncome)
                });

                if ((pensionPot + isaPot) <= 0 && !runOutAge && currentAge >= inputs.retirementAge) {
                    runOutAge = currentAge;
                    pensionPot = 0;
                    isaPot = 0;
                }
            }

            return { savingsTrajectory, runOutAge, endAge };
        }

        function calculateSustainableIncomeIncrease(finalPensionPot, finalIsaPot, inputs) {
            const totalFinalPot = finalPensionPot + finalIsaPot;
            const yearsInRetirement = 100 - inputs.retirementAge;
            const conservativeFactor = 0.8;

            const theoreticalMaxIncrease = (totalFinalPot / yearsInRetirement) * conservativeFactor;

            return Math.round(theoreticalMaxIncrease);
        }

        function calculateRecommendations(results, inputs) {
            const finalYear = results.savingsTrajectory[results.savingsTrajectory.length - 1];
            const finalPensionPot = finalYear.pensionSavings;
            const finalIsaPot = finalYear.isaSavings;
            const hasSavingsAtEnd = (finalPensionPot + finalIsaPot) > 0;

            // Get state pension amount for minimum income floor
            const statePensionAtRetirement = 11502 * Math.pow(1 + inputs.inflationRate / 100, inputs.retirementAge - inputs.currentAge);
            const lifeExpectancy = results.endAge;

            if (!results.runOutAge && hasSavingsAtEnd) {
                const sustainableIncrease = calculateSustainableIncomeIncrease(finalPensionPot, finalIsaPot, inputs);
                return {
                    isAchievable: true,
                    sustainableIncome: Math.round(inputs.desiredPostTaxIncome + sustainableIncrease),
                    lifeExpectancy
                };
            }

            // Calculate income shortfall at retirement
            const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
            const rate = inputs.returnRate / 100;

            // Find the yearly shortfall at retirement
            const retirementData = results.savingsTrajectory.find(year => year.age === inputs.retirementAge);
            const retirementIncome = retirementData ? retirementData.totalIncome : 0;
            const yearlyShortfall = inputs.desiredPostTaxIncome - retirementIncome;

            // Calculate capital needed at retirement to generate the shortfall
            const capitalNeededForShortfall = yearlyShortfall / (rate * 0.9); // Using 90% of return rate for safety margin

            // Calculate future value of current savings at retirement
            const currentSavings = inputs.currentPensionSavings + inputs.currentIsaSavings;
            const futureValueCurrentSavings = currentSavings * Math.pow(1 + rate, yearsToRetirement);

            // Calculate future value of current contributions
            const currentAnnualContributions = inputs.annualPensionContributions + inputs.annualIsaContributions;
            const futureValueCurrentContributions = currentAnnualContributions * ((Math.pow(1 + rate, yearsToRetirement) - 1) / rate);

            // Calculate additional capital needed
            const totalNeededAtRetirement = capitalNeededForShortfall;
            const currentProjectedCapital = futureValueCurrentSavings + futureValueCurrentContributions;
            const additionalCapitalNeeded = Math.max(0, totalNeededAtRetirement - currentProjectedCapital);

            // Calculate additional annual contributions needed
            const additionalAnnualContributions = Math.round(
                (additionalCapitalNeeded * rate) / (Math.pow(1 + rate, yearsToRetirement) - 1)
            );

            // Calculate sustainable income with current savings and contributions
            const sustainableIncome = Math.round(Math.max(
                retirementIncome,
                statePensionAtRetirement
            ));

            // Calculate years to delay retirement
            const yearlyCapitalGrowth = (currentSavings * rate) + currentAnnualContributions;
            const yearsToDelay = Math.ceil(
                Math.log(totalNeededAtRetirement / currentProjectedCapital) / Math.log(1 + rate)
            );

            return {
                isAchievable: false,
                yearsToDelay: yearsToDelay,
                additionalContributions: additionalAnnualContributions,
                sustainableIncome: sustainableIncome,
                lifeExpectancy
            };
        }

        function updateCharts(results) {
            const ctx1 = document.getElementById('savingsChart').getContext('2d');
            const ctx2 = document.getElementById('incomeChart').getContext('2d');

            if (savingsChart) savingsChart.destroy();
            if (incomeChart) incomeChart.destroy();

            savingsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: results.savingsTrajectory.map(d => d.age),
                    datasets: [{
                        label: 'Private Pension',
                        data: results.savingsTrajectory.map(d => d.pensionSavings),
                        borderColor: '#2563eb',
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)'
                    },
                    {
                        label: 'ISA',
                        data: results.savingsTrajectory.map(d => d.isaSavings),
                        borderColor: '#22c55e',
                        fill: true,
                        backgroundColor: 'rgba(34, 197, 94, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: {
                                callback: value => `£${(value / 1000).toLocaleString()}k`
                            }
                        }
                    }
                }
            });

            incomeChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: results.savingsTrajectory.map(d => d.age),
                    datasets: [{
                        label: 'Tax-Free Lump Sum',
                        data: results.savingsTrajectory.map(d => d.lumpSum),
                        backgroundColor: '#fbbf24'
                    },
                    {
                        label: 'Post-Retirement Income',
                        data: results.savingsTrajectory.map(d => d.postRetirementIncome),
                        backgroundColor: '#9333ea'
                    },
                    {
                        label: 'State Pension',
                        data: results.savingsTrajectory.map(d => d.statePension),
                        backgroundColor: '#ef4444'
                    },
                    {
                        label: 'ISA Income',
                        data: results.savingsTrajectory.map(d => d.isaWithdrawal),
                        backgroundColor: '#22c55e'
                    },
                    {
                        label: 'Pension Income (Post-Tax)',
                        data: results.savingsTrajectory.map(d => d.pensionWithdrawalPostTax),
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            stacked: true,
                            ticks: {
                                callback: value => `£${(value / 1000).toLocaleString()}k`
                            }
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            });
        }

        function calculateAlternativeScenarios(inputs, results) {
            const rate = inputs.returnRate / 100;
            const yearsToRetirement = inputs.retirementAge - inputs.currentAge;

            // Get retirement year data
            const retirementData = results.savingsTrajectory.find(year => year.age === inputs.retirementAge);
            const retirementIncome = retirementData ? retirementData.totalIncome : 0;
            const shortfall = inputs.desiredPostTaxIncome - retirementIncome;

            // Current values
            const currentSavings = inputs.currentPensionSavings + inputs.currentIsaSavings;
            const currentContributions = inputs.annualPensionContributions + inputs.annualIsaContributions;

            // 1. Calculate required additional annual contributions
            const futureValue = shortfall / rate;
            const requiredTotalContributions = (futureValue * rate) / (Math.pow(1 + rate, yearsToRetirement) - 1);
            const additionalContributionsNeeded = Math.max(0, requiredTotalContributions - currentContributions);

            // 2. Calculate required retirement age
            let requiredAge = inputs.retirementAge;
            let projectedSavings = currentSavings;
            while (projectedSavings * rate < inputs.desiredPostTaxIncome && requiredAge < 100) {
                projectedSavings = (projectedSavings + currentContributions) * (1 + rate);
                requiredAge++;
            }

            // 3. Calculate achievable income with current plan
            const achievableIncome = Math.max(
                retirementIncome,
                currentSavings * rate + currentContributions * ((Math.pow(1 + rate, yearsToRetirement) - 1) / rate) * rate
            );

            return {
                additionalContributions: Math.round(additionalContributionsNeeded),
                requiredAge,
                achievableIncome: Math.round(achievableIncome)
            };
        }

        function showAlternativeScenarios() {
            const results = calculatePension(inputs);
            const scenarios = calculateAlternativeScenarios(inputs, results);

            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-4">Alternative Scenarios</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse table-auto">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border px-4 py-2 text-left">Scenario</th>
                                        <th class="border px-4 py-2 text-left">Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border px-4 py-2">Required Additional Annual Contribution</td>
                                        <td class="border px-4 py-2">£${scenarios.additionalContributions.toLocaleString()} per year</td>
                                    </tr>
                                    <tr>
                                        <td class="border px-4 py-2">Required Retirement Age</td>
                                        <td class="border px-4 py-2">${scenarios.requiredAge} years old</td>
                                    </tr>
                                    <tr>
                                        <td class="border px-4 py-2">Achievable Annual Income</td>
                                        <td class="border px-4 py-2">£${scenarios.achievableIncome.toLocaleString()} per year</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }


        
        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function calculateRetirementScore(results, inputs) {
            // Score is centered on 0 (best) and aims for ~£0 savings at age 90
            // Negative = under-funded (income shortfall or running out before 90)
            // Positive = over-funded (material savings left at 90)
            const desiredToday = inputs.desiredPostTaxIncome;

            if (!desiredToday || desiredToday <= 0) {
                return {
                    score: 0,
                    note: "Set a desired post-tax income to see your score.",
                    targetAge: 90,
                    endSavingsAtTargetAge: null,
                    minRetIncomeToday: null
                };
            }

            const targetAge = 90;

            // Retirement years only
            const retirementYears = results.savingsTrajectory.filter(y => y.age >= inputs.retirementAge);
            if (!retirementYears.length) {
                return {
                    score: 0,
                    note: "No retirement years to score (check ages).",
                    targetAge,
                    endSavingsAtTargetAge: null,
                    minRetIncomeToday: null
                };
            }

            // Worst-year retirement income (in today's pounds, because desiredToday is in today's pounds)
            const minRetIncomeToday = Math.min(...retirementYears.map(y => y.totalIncome));
            const coverage = minRetIncomeToday / desiredToday;

            // If income is below target at any point in retirement, score goes negative (under-funded)
            if (coverage < 1) {
                const under = Math.max(0, Math.min(100, (1 - coverage) * 100));
                return {
                    score: -Math.round(under),
                    note: null,
                    targetAge,
                    endSavingsAtTargetAge: null,
                    minRetIncomeToday: Math.round(minRetIncomeToday)
                };
            }

            // If we run out of savings before target age, negative score based on how early
            if (results.runOutAge && results.runOutAge < targetAge) {
                const span = Math.max(1, targetAge - inputs.retirementAge);
                const yearsEarly = targetAge - results.runOutAge;
                const under = Math.max(0, Math.min(100, (yearsEarly / span) * 100));
                return {
                    score: -Math.round(under),
                    note: null,
                    targetAge,
                    endSavingsAtTargetAge: 0,
                    minRetIncomeToday: Math.round(minRetIncomeToday)
                };
            }

            // Otherwise: penalize "money left at age 90" (over-funded)
            const atTarget = results.savingsTrajectory.find(y => y.age === targetAge) || results.savingsTrajectory[results.savingsTrajectory.length - 1];
            const endSavingsAtTargetAge = atTarget ? atTarget.totalSavings : 0;

            // Convert today's desired income to nominal at target age for scaling (rough, but consistent)
            const yearsToTarget = Math.max(0, targetAge - inputs.currentAge);
            const infl = inputs.inflationRate / 100;
            const desiredAtTarget = desiredToday * Math.pow(1 + infl, yearsToTarget);

            // Oversave in "years of desired income" at target age
            const oversaveYears = desiredAtTarget > 0 ? (endSavingsAtTargetAge / desiredAtTarget) : 0;

            // Map: 0 years left -> 0 score; 5+ years left -> +100 score (clamped)
            const over = Math.max(0, Math.min(100, (oversaveYears / 5) * 100));

            return {
                score: Math.round(over),
                note: null,
                targetAge,
                endSavingsAtTargetAge: Math.round(endSavingsAtTargetAge),
                minRetIncomeToday: Math.round(minRetIncomeToday)
            };
        }

function scoreLabel(score) {
            const abs = Math.abs(score);
            if (abs <= 10) return { text: "Optimised (aiming for ~£0 at 90)", tone: "text-green-700" };
            if (score < 0) {
                if (abs <= 30) return { text: "Slightly under-funded", tone: "text-amber-700" };
                if (abs <= 70) return { text: "Under-funded", tone: "text-orange-700" };
                return { text: "Significantly under-funded", tone: "text-red-700" };
            } else {
                if (abs <= 30) return { text: "Slightly over-funded", tone: "text-amber-700" };
                if (abs <= 70) return { text: "Over-funded", tone: "text-orange-700" };
                return { text: "Significantly over-funded", tone: "text-red-700" };
            }
        }

function scoreBarColor(score) {
            // Green near 0, warmer colors as you deviate
            const abs = Math.abs(score);
            if (abs <= 10) return "bg-green-500";
            if (abs <= 30) return "bg-amber-500";
            if (abs <= 70) return "bg-orange-500";
            return "bg-red-500";
        }



        function getSavingsAtAge(results, age) {
            const row = results.savingsTrajectory.find(y => y.age === age);
            if (row) return { total: row.totalSavings, pension: row.pensionSavings, isa: row.isaSavings };
            const last = results.savingsTrajectory[results.savingsTrajectory.length - 1];
            return { total: last.totalSavings, pension: last.pensionSavings, isa: last.isaSavings };
        }

        function getMinRetIncomeToday(results, inputs) {
            const retirementYears = results.savingsTrajectory.filter(y => y.age >= inputs.retirementAge);
            if (!retirementYears.length) return 0;
            return Math.min(...retirementYears.map(y => y.totalIncome));
        }

        function evaluatePlanForTarget(results, inputs, targetAge) {
            const minRetIncomeToday = getMinRetIncomeToday(results, inputs);
            const coverage = inputs.desiredPostTaxIncome > 0 ? (minRetIncomeToday / inputs.desiredPostTaxIncome) : 0;

            const s90 = getSavingsAtAge(results, targetAge).total;
            const s91 = getSavingsAtAge(results, targetAge + 1).total;

            const runsOutBeforeTarget = !!(results.runOutAge && results.runOutAge < targetAge);
            const meetsIncomeTarget = coverage >= 1;

            // Objective: be close to zero at target age, while meeting income target and not running out early.
            // Add big penalties for failing constraints.
            let objective = Math.abs(s90);
            if (!meetsIncomeTarget) objective += 1e9;
            if (runsOutBeforeTarget) objective += 1e9;

            return {
                coverage,
                minRetIncomeToday,
                s90,
                s91,
                runsOutBeforeTarget,
                meetsIncomeTarget,
                objective
            };
        }

        function formatMoney(n) {
            const v = Math.round(n);
            const sign = v < 0 ? "-" : "";
            return `${sign}£${Math.abs(v).toLocaleString()}`;
        }

        function generateRecommendations90(results, inputs) {
            const targetAge = 90;
            const eval0 = evaluatePlanForTarget(results, inputs, targetAge);
            const s91 = eval0.s91;

            // On track / oversaving (as per your rule: >£0 at age 91)
            if (s91 >= 0 && eval0.meetsIncomeTarget && !eval0.runsOutBeforeTarget) {
                const yearsToRet = Math.max(0, inputs.retirementAge - inputs.currentAge);
                const spreadYears = yearsToRet > 0 ? yearsToRet : 10;
                const extraPerYear = s91 / spreadYears;
                const extraPerMonth = extraPerYear / 12;

                const tier =
                    s91 <= 50000 ? "small" :
                    s91 <= 250000 ? "moderate" : "large";

                const tierCopy =
                    tier === "small" ? "You’re broadly optimised for finishing near £0 by 90, with a small buffer left." :
                    tier === "moderate" ? "You’re on track, and you’re likely saving more than you need to hit ~£0 by 90." :
                    "You’re comfortably ahead of the ‘£0 at 90’ target — you may be over-saving for this goal.";

                const html = `
                    <h3 class="section-title">Recommendations</h3>
                    <div class="p-4 bg-white rounded border">
                        <div class="font-semibold text-green-700">On track (you could choose to enjoy more now)</div>
                        <div class="mt-2 text-gray-700">
                            ${tierCopy}
                        </div>
                        <div class="mt-3 text-sm text-gray-700">
                            <div>Estimated savings left at age 91: <span class="font-semibold">${formatMoney(s91)}</span></div>
                            <div class="mt-1">
                                If you wanted to tilt toward “spend it down by 90”, a simple option is to spend or give roughly
                                <span class="font-semibold">${formatMoney(extraPerYear)}</span> per year (≈ ${formatMoney(extraPerMonth)}/month)
                                between now and retirement.
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            Other options (not applied automatically): slightly reduce contributions, retire a bit earlier, or increase your retirement spending target.
                        </div>
                    </div>
                `;

                return {
                    isAchievable: true,
                    html,
                    targetAge,
                    endSavingsAge91: s91
                };
            }

            // Under-funded: try to find a "reasonable combination" of:
            // - save more (increase annual contributions)
            // - retire later (increase retirement age)
            // - spend less in retirement (reduce desired post-tax income)
            // that gets close to £0 at age 90 while meeting income target.
            const yearsToRet = Math.max(0, inputs.retirementAge - inputs.currentAge);

            // Caps / "reasonable" thresholds (can be shown to user)
            const caps = {
                maxRetireDelayPreferred: 3,
                maxRetireDelayHard: 5,
                maxSpendCutPreferred: 0.08,
                maxSpendCutHard: 0.15,
                maxExtraContribPreferred: 6000,  // £/yr
                maxExtraContribHard: 12000       // £/yr
            };

            // Grid search within hard caps; we’ll prefer solutions within preferred caps.
            const retireDelays = [0, 1, 2, 3, 4, 5];
            const spendCuts = [0, 0.03, 0.06, 0.10, 0.15];
            const extraContribs = [0, 1200, 2400, 3600, 6000, 9000, 12000];

            function solutionPenalty(sol) {
                // Prefer staying within "preferred" thresholds
                let p = 0;
                if (sol.retireDelay > caps.maxRetireDelayPreferred) p += (sol.retireDelay - caps.maxRetireDelayPreferred) * 10;
                if (sol.spendCut > caps.maxSpendCutPreferred) p += ((sol.spendCut - caps.maxSpendCutPreferred) / 0.01) * 2;
                if (sol.extraContrib > caps.maxExtraContribPreferred) p += ((sol.extraContrib - caps.maxExtraContribPreferred) / 1000) * 5;

                // Also prefer fewer changes generally
                p += sol.retireDelay * 2;
                p += sol.spendCut * 100;
                p += sol.extraContrib / 2000;
                return p;
            }

            let best = null;

            for (const retireDelay of retireDelays) {
                for (const spendCut of spendCuts) {
                    for (const extraContrib of extraContribs) {
                        // If already retired, don't suggest delaying retirement negatively (we still allow 0..5 to mean "work longer")
                        const modInputs = { ...inputs };
                        modInputs.retirementAge = inputs.retirementAge + retireDelay;

                        // Reduce desired spend
                        modInputs.desiredPostTaxIncome = Math.max(0, Math.round(inputs.desiredPostTaxIncome * (1 - spendCut)));

                        // Increase contributions (keep pension/ISA split proportional to current)
                        const baseTotal = (inputs.annualPensionContributions + inputs.annualIsaContributions);
                        const pensionShare = baseTotal > 0 ? (inputs.annualPensionContributions / baseTotal) : 0.8;
                        const isaShare = 1 - pensionShare;

                        modInputs.annualPensionContributions = Math.round(inputs.annualPensionContributions + extraContrib * pensionShare);
                        modInputs.annualIsaContributions = Math.round(inputs.annualIsaContributions + extraContrib * isaShare);

                        const sim = calculatePension(modInputs);
                        const ev = evaluatePlanForTarget(sim, modInputs, targetAge);

                        // Only consider valid plans (meet income & don't run out before target)
                        if (!ev.meetsIncomeTarget || ev.runsOutBeforeTarget) continue;

                        const candidate = {
                            retireDelay,
                            spendCut,
                            extraContrib,
                            s90: ev.s90,
                            s91: ev.s91,
                            minRetIncomeToday: ev.minRetIncomeToday,
                            coverage: ev.coverage,
                            objective: ev.objective
                        };

                        // Choose best by: closeness to zero at 90, then lower penalty
                        if (!best) {
                            best = candidate;
                        } else {
                            const bestPenalty = solutionPenalty(best);
                            const candPenalty = solutionPenalty(candidate);

                            // Primary: abs(s90) smaller
                            const candAbs = Math.abs(candidate.s90);
                            const bestAbs = Math.abs(best.s90);

                            if (candAbs < bestAbs - 1) {
                                best = candidate;
                            } else if (Math.abs(candAbs - bestAbs) <= 1 && candPenalty < bestPenalty) {
                                best = candidate;
                            }
                        }
                    }
                }
            }

            const thresholdsHtml = `
                <div class="mt-3 text-sm text-gray-700">
                    <div class="font-semibold">What we count as a “reasonable combination” (defaults)</div>
                    <ul class="list-disc pl-5 mt-1">
                        <li><span class="font-semibold">Save more now:</span> +£1,200 to £6,000 per year (preferred), up to £12,000/year</li>
                        <li><span class="font-semibold">Retire later:</span> +1 to +3 years (preferred), up to +5 years</li>
                        <li><span class="font-semibold">Spend less in retirement:</span> -2% to -8% (preferred), up to -15%</li>
                    </ul>
                    <div class="mt-2 text-gray-600">
                        We aim to blend changes so you’re close to £0 at age 90 without relying on a single extreme lever.
                    </div>
                </div>
            `;

            // If we couldn't find any valid solution within caps, present guidance without pretending
            if (!best) {
                const html = `
                    <h3 class="section-title">Recommendations</h3>
                    <div class="p-4 bg-white rounded border">
                        <div class="font-semibold text-amber-700">Not on track for the “£0 at 90” goal (without bigger changes)</div>
                        <div class="mt-2 text-gray-700">
                            Your current plan appears to fall short before age ${targetAge}, or drops below your target income at some point.
                            To reach ~£0 at age 90 while meeting your target income, you’d likely need changes beyond the “reasonable” ranges below.
                        </div>
                        ${thresholdsHtml}
                    </div>
                `;

                return { isAchievable: false, html, targetAge, endSavingsAge91: s91 };
            }

            // Build the recommended combo text
            const retireText = best.retireDelay > 0 ? `Retire <span class="font-semibold">${best.retireDelay}</span> year(s) later (to age <span class="font-semibold">${inputs.retirementAge + best.retireDelay}</span>)` : null;
            const spendText = best.spendCut > 0 ? `Reduce retirement spending target by <span class="font-semibold">${Math.round(best.spendCut * 100)}%</span> (to <span class="font-semibold">£${Math.round(inputs.desiredPostTaxIncome * (1 - best.spendCut)).toLocaleString()}</span> / year)` : null;
            const contribText = best.extraContrib > 0 ? `Increase total contributions by <span class="font-semibold">£${best.extraContrib.toLocaleString()}</span> / year (≈ <span class="font-semibold">£${Math.round(best.extraContrib / 12).toLocaleString()}</span> / month)` : null;

            const combo = [contribText, retireText, spendText].filter(Boolean);

            const isWithinPreferred =
                best.retireDelay <= caps.maxRetireDelayPreferred &&
                best.spendCut <= caps.maxSpendCutPreferred &&
                best.extraContrib <= caps.maxExtraContribPreferred;

            const headingTone = isWithinPreferred ? "text-amber-700" : "text-orange-700";
            const headingText = isWithinPreferred
                ? "Needs adjustment (a reasonable combination can get you to ~£0 at 90)"
                : "Needs adjustment (solution found, but it’s a bigger set of changes)";

            const html = `
                <h3 class="section-title">Recommendations</h3>
                <div class="p-4 bg-white rounded border">
                    <div class="font-semibold ${headingTone}">${headingText}</div>

                    <div class="mt-2 text-gray-700">
                        Based on your goal of finishing near £0 at age 90, here’s a balanced set of changes that gets close to target:
                    </div>

                    <ul class="list-disc pl-5 mt-2 text-gray-800">
                        ${combo.map(x => `<li>${x}</li>`).join("")}
                    </ul>

                    <div class="mt-3 text-sm text-gray-700">
                        With these adjustments, projected savings at age 90 are approximately <span class="font-semibold">${formatMoney(best.s90)}</span>
                        (aiming for £0), while meeting your income target.
                    </div>

                    ${thresholdsHtml}
                </div>
            `;

            return {
                isAchievable: false,
                html,
                targetAge,
                endSavingsAge91: best.s91,
                suggested: best
            };
        }





function updateResults(results, inputs) {
            latestInputs = inputs;
            latestResults = results;
            // Enable save button once logged in
            updateAuthUI();
            const summary = document.getElementById('summary');
            const resultsDiv = document.getElementById('results');
            const resultsTable = document.getElementById('resultsTable');

            resultsDiv.classList.remove('hidden');

            const recommendations = generateRecommendations90(results, inputs);
            const scoreObj = calculateRetirementScore(results, inputs);
            const scoreMeta = scoreLabel(scoreObj.score);
            const scoreHalf = (clamp(Math.abs(scoreObj.score), 0, 100) / 100) * 50;
            const scoreLeftFill = scoreObj.score < 0 ? scoreHalf : 0;
            const scoreRightFill = scoreObj.score > 0 ? scoreHalf : 0;

            const scoreDetailsHtml = scoreObj.note
                ? `<div class="mt-2 text-sm text-gray-600">${scoreObj.note}</div>`
                : `<div class="mt-2 text-sm text-gray-600">
                       Worst-year retirement income (today's £): <span class="font-semibold">£${(scoreObj.minRetIncomeToday ?? 0).toLocaleString()}</span>
                       vs target <span class="font-semibold">£${inputs.desiredPostTaxIncome.toLocaleString()}</span><br/>
                       Savings at age ${scoreObj.targetAge}: <span class="font-semibold">£${(scoreObj.endSavingsAtTargetAge ?? 0).toLocaleString()}</span>
                   </div>`;

            const scoreHtml = `
                <div class="mb-4 p-4 bg-white rounded border">
                    <div class="flex items-baseline justify-between">
                        <div class="font-semibold">Retirement Score</div>
                        <div class="text-2xl font-bold ${scoreMeta.tone}">${scoreObj.score}</div>
                    </div>

                    <div class="mt-2 text-sm ${scoreMeta.tone} font-semibold">${scoreMeta.text}</div>

                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded h-3 overflow-hidden relative">
                            <!-- center marker -->
                            <div class="absolute top-0 bottom-0" style="left:50%; width:2px; background: rgba(0,0,0,0.25);"></div>

                            <!-- negative fill (from center to left) -->
                            ${scoreLeftFill > 0 ? `<div class="${scoreBarColor(scoreObj.score)} h-3 absolute" style="right:50%; width:${scoreLeftFill}%;"></div>` : ``}

                            <!-- positive fill (from center to right) -->
                            ${scoreRightFill > 0 ? `<div class="${scoreBarColor(scoreObj.score)} h-3 absolute" style="left:50%; width:${scoreRightFill}%;"></div>` : ``}
                        </div>

                        <div class="mt-2 text-xs text-gray-600 flex justify-between">
                            <span>-100</span><span>0</span><span>+100</span>
                        </div>
                    </div>

                    ${scoreDetailsHtml}
                </div>
            `;

            if (recommendations.isAchievable) {
                summary.innerHTML = `
                    <h3 class="section-title">Summary</h3>
                    ${scoreHtml}
                    <div class="mb-4 p-4 bg-gray-100 rounded">
                        <div class="font-semibold text-green-600">
                            Yes, you're on track for your desired retirement lifestyle!
                        </div>
                        <div class="mt-2">
                            <p>Based on your current plan, you will have sufficient income throughout your retirement.</p>
                            <p class="mt-2 text-sm text-gray-600">
                                Note: Calculations are based on a projection horizon of ${results.endAge} years for someone currently aged ${inputs.currentAge}.
                            </p>
                        </div>
                    </div>
                ${recommendations.html}
                `;
            } else {
                summary.innerHTML = `
                    <h3 class="section-title">Summary</h3>
                    ${scoreHtml}
                    <div class="mb-4 p-4 bg-gray-100 rounded">
                        <div class="font-semibold text-amber-600">
                            Your current plan needs some adjustments to meet your retirement goals.
                        </div>
                        <div class="mt-2">
                            <p>Consider these options to improve your retirement plan: increase your pension contributions, reduce your target retirement income, or delay your retirement.</li>
                            </ul>
                            <p class="mt-2 text-sm text-gray-600">
                                Note: Calculations are based on a projection horizon of ${results.endAge} years for someone currently aged ${inputs.currentAge}.
                            </p>
                        </div>
                    </div>
                ${recommendations.html}
                `;
            }

            updateCharts(results);

            resultsTable.innerHTML = results.savingsTrajectory.map(year => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">${year.age}</td>
                    <td class="px-4 py-2">£${year.totalSavings.toLocaleString()}</td>
                    <td class="px-4 py-2">£${year.returns.toLocaleString()}</td>
                    <td class="px-4 py-2">${year.contributions > 0 ? `£${year.contributions.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2">${year.pensionWithdrawalPostTax > 0 ? `£${year.pensionWithdrawalPostTax.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2">${year.isaWithdrawal > 0 ? `£${year.isaWithdrawal.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2">${year.postRetirementIncome > 0 ? `£${year.postRetirementIncome.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2">${year.statePension > 0 ? `£${year.statePension.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2 font-semibold">${year.totalIncome > 0 ? `£${year.totalIncome.toLocaleString()}` : '-'}</td>
                </tr>
            `).join('');
        }

        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const inputs = {
                currentAge: Number(formData.get('currentAge')),
                retirementAge: Number(formData.get('retirementAge')),
                currentPensionSavings: Number(formData.get('currentPensionSavings')),
                annualPensionContributions: Number(formData.get('annualPensionContributions')),
                currentIsaSavings: Number(formData.get('currentIsaSavings')),
                annualIsaContributions: Number(formData.get('annualIsaContributions')),
                desiredPostTaxIncome: Number(formData.get('desiredPostTaxIncome')),
                postRetirementIncome: Number(formData.get('postRetirementIncome')),
                returnRate: Number(formData.get('returnRate')),
                inflationRate: Number(formData.get('inflationRate')),
                takeLumpSum: formData.get('takeLumpSum') === 'on'
            };

            const results = calculatePension(inputs);
            updateResults(results, inputs);
        });

        // ----------------------------
        // Auth UI wiring
        // ----------------------------
        document.getElementById('authSendLinkBtn').addEventListener('click', async () => {
            try {
                const email = (document.getElementById('authEmail').value || '').trim();
                if (!email) {
                    setAuthStatus('Enter an email address.', 'text-red-700');
                    return;
                }
                setAuthStatus('Sending magic link… check your email.', 'text-gray-700');
                await sendMagicLink(email);
                setAuthStatus('Magic link sent. Open it on this device to finish logging in.', 'text-green-700');
            } catch (e) {
                setAuthStatus('Could not send login link. Check Supabase settings.', 'text-red-700');
            }
        });

        document.getElementById('authLogoutBtn').addEventListener('click', async () => {
            try {
                await logout();
                setAuthStatus('Logged out.', 'text-gray-700');
                await updateAuthUI();
            } catch (e) {
                setAuthStatus('Could not log out.', 'text-red-700');
            }
        });

        document.getElementById('saveRunBtn').addEventListener('click', async () => {
            try {
                await saveCurrentRun();
                await updateAuthUI();
            } catch (e) {
                setAuthStatus('Could not save. Check that the pension_runs table + RLS policies exist.', 'text-red-700');
            }
        });

        // Keep UI in sync with auth state
        (function initAuth() {
            const client = ensureSupabaseClient();
            if (client) {
                client.auth.onAuthStateChange(async () => {
                    await updateAuthUI();
                });
            }
            updateAuthUI();
        })();

    </script>
</body>
</html>
